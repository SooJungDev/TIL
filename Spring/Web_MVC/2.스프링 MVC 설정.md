## 스프링 MVC 설정

## 스프링 MVC 구성요소 직접 빈으로 등록하기
@Configuration을 사용한 자바 설정 파일에 직접 @Bean을 사용해서 등록하기

## @EnableWebMvc
애노테이션 기반 스프링 MVC 를 사용할때 편리한 웹 MVC 기본설정
~~~java
@Configuration
@EnableWebMvc
public class WebConfig{
}
~~~

## WebMvcConfigurer 인터페이스
@EnableWebMvc 가 제공하는 빈을 커스터마이징할수 있는 기능을 제공하는 인터페이스
~~~java
@Configuration
@EnableWebMvc
public class WebConfig implements WebMvcCofigurer{

 @Override
 public void configreViewResolvoers(ViewResolverRegistry regristry){
    registry.jsp("/WEB-INF/",".jsp");
  }
}
~~~

## 스프링 부트의 스프링 MVC 설정

스프링 부트의 "주관"이 적용된 자동설정이 동작한다.
- JSP 보다는 Thymeleaf 선호
- JSON 지원
- 정적 리소스 지원(+ 월컴페이지, 파비콘 등을 지원)

스프링 MVC 커스터마이징  
- application.properties
- @Configuration + Implements WebMvcConfigurer: 스프링 부트의 스프링 MVC 자동설정 + 추가설정 
- @Configuration + @EnableWebMvc+ Implements WebMvcConfigurer: 스프링 부트이 스프링 MVC 자동설정 사용하지 않음

## 스프링 부트에서 JSP 사용하기
- 가능하다면 JSP 는 피하는 것이 좋음
    - 내장형 서블릿 컨테이너와 함꼐 사용할 경우 몇가지 알려진 제약사항이 있음
- [Springboot 에서 지원하는 Template Engines](https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-spring-mvc-template-engines)

제약사항
- JAR 프로젝트로 만들 수 없음, WAR 프로젝트로 만들어야함
- JAVA - JAR로 실행 할 수는 있지만, "실행가능한 JAR파일"은 지원하지 않음
- 언더토우(JBoss에서 만든 서블릿 컨테이너)는 JSP를 지원하지 않음
- Whitelabel 에러 페이지를 error.jsp 로 오버라이딩 할 수 없음

참고
- [JSP Limitations](https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#boot-features-jsp-limitations)
- [Springboot jsp sample 프로젝트](https://github.com/spring-projects/spring-boot/tree/v2.1.1.RELEASE/spring-boot-samples/spring-boot-sample-web-jsp) 

의존성 추가
~~~
<​dependency​>
  <groupId>javax.servlet</groupId>
  <artifactId>jstl</artifactId>
</​dependency​>
<​dependency​>
  <groupId>org.apache.tomcat.embed</groupId>
  <artifactId>tomcat-embed-jasper</artifactId>
  <scope>provided</scope>
</​dependency​>
 

~~~

태그 선언
~~~
<%@ ​taglib ​prefix​="​c​" ​uri​="h​ ttp://java.sun.com/jsp/jstl/core​"%>
~~~

application.properties
~~~
spring.mvc.view.prefix​=​/WEB-INF/jsp 
spring.mvc.view.suffix​=​.jsp
~~~

## WAR 파일 배포하기
java -jar를 사용해서 실행하기  
- SpringApplication.run 사용하기

서블릿 컨테이너에 배포하기   
- SpringBootServletInitializer (WebApplicationInitializer) 사용하기  

## 포매터 추가하기
- [addFormatters](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/config/annotation/WebMvcConfigurer.html#addFormatters-org.springframework.format.FormatterRegistry-)

Formatter
- Printer: 해당 객체를(Locale 정보를 참고하여) 문자열로 어떻게 출력할 것인가
- Parser: 어떤 문자열을(Locale 정보를 참고하여) 객체로 어떻게 변환할 것인가

- [Interface Formatter](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/format/Formatter.html)

포매터 추가하는 방법1
-  WebMvcConfigurer 의 addFormatters(FormattterRegistry) 메소드 정의

포매터 추가하는 방법2(스프링 부트 사용시에만 가능함)
- 해당 포매터를 빈으로 등록

## 도메인 클래스 컨버터 자동등록
스프링 데이터 JPA는 스프링 MVC 용 도메인 클래스 컨버터를 제공

도메인 클래스 컨버터
- 스프링 데이터 JPA 가 제공하는 Repository를 사용해서 ID에 해당하는 엔티티를 읽어옵니다.

의존성설정
~~~
<​dependency​>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-jpa</artifactId>
</​dependency​>
<​dependency​>
  <groupId>com.h2database</groupId>
  <artifactId>h2</artifactId>
</​dependency​>
~~~

엔티티 맵핑
~~~java
@Entity
public class Person{

    @Id @GeneratedValue    
    private Integer id;
}
~~~

리파지토리추가  
~~~java
public interface PersonRepostiory extends JpaRepostiory<Person, Integer>{
}
~~~

테스트코드 수정
- 테스트용 이벤트 객체 생성
- 이벤트 리파지토리에 저장
- 저장한 이벤트의 ID로 조회시도

## 핸들러 인터셉터 개념
- [WebMvcConfigurer addInterceptors](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/config/annotation/WebMvcConfigurer.html#addInterceptors-org.springframework.web.servlet.config.annotation.InterceptorRegistry-)

HandlerInterceptor
- 핸들러 맵핑에 설정 할 수 있는 인터셉터
- 핸들러를 실행하기전, 후 (아직 랜더링전) 그리고 완료(렌더링까지 끝난 이후) 시점에 부가작업을 하고 싶은 경우에 사용 할 수있음
- 여러 핸들러에서 반복적으로 사용하는 코드를 줄이고싶을떄 사용 할 수 있음
    - 로깅 인증 체크 ,Locale 변경등
    
boolean preHandle(request, response, handler)  
- 핸들러 실행하기전에 호출됨
- 핸들러 에 대한 정보를 사용 할 수있기때문에 서블릿 필터에 비해 보다 세밀한 로직을 구현 할 수 있다.
- 리턴 값으로 계속 다음 인터셉터 또는 핸들러로, 요청,응답을 전달할지(true) 응답처리가 이곳에서 끝났는지(false) 알린다.

void postHandle(request, response, modelAndView)
- 핸들러 실행이 끝나고 아직 뷰를 렌더링하기 이전에 호출됨
- "뷰"에 전달할 추가적이거나 여러 핸들러에 공통적인 모델 정보를 담는데 사용 할 수 도 있다.
- 이 메소드는 인터셉터 역순으로 호출된다.
- 비동기적인 요청처리시에는 호출되지 않는다.

void afterCompletion(request, response, handler, ex)
- 요청 처리가 완전히 끝난 뒤(뷰 렌더링 끝난 뒤)에 호출됨
- 뷰에 전달 할 추가적이거나 여러 핸들러에 공통적인 모델 정보를 담는데 사용 할 수 도 있다.
- 이 메소드는 인터셉터 역순으로 호출된다.
- 비동기적인 요청 처리시에는 호출되지 않는다.

void afterCompletion(request,response,handler, ex)
- 요청처리가 완전히 끝난(뷰 랜더링이 끝난뒤)에 호출됨
- preHandler 에서 true 를 리턴한 경우에만 호출 됨
- 이 메소드는 인터셉터 역순으로 호출된다.
- 비동기적인 요청 처리 시에는 호출 되지 않는다.

vs 서블릿 필터
- 서블릿 보다 구체적인 처리가 가능하다.
- 서블릿은 보다 일반적인 용도의 기능을 구현하는데 사용하는게 좋다.

참고
- [HandlerInterceptor](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/HandlerInterceptor.html)
- [AsyncHandlerInterceptor](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/AsyncHandlerInterceptor.html)
- [스프링 개발자 Mark Fisher의 서블릿 필터와의 차이점에 대한 답변 참고](https://spring.io/blog/2019/02/06/legacy-forums-will-be-shutdown-february-28)   


## 핸들러 인터셉터 만들고 등록하기
- 핸들러 인터셉터 구현하기
~~~java
public class GreetringInterceptor implements HandlerInterceptor{
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) threows Exception{
        System.out.println("preHandle 1");
    }
    
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception{
        System.out.println("postHandle 1");
    }
    
    @Override
    public void after Completion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)throws Exception{
        System.out.println("afterCompletion 1");
    }

}
~~~
- 핸들러 인터셉터 등록하기
~~~java
@Configuration
public class WebConfig implements WebMvcConfigurer{

    @Override
    public void addInterceptor(InterceptorRegistry registry){
           registry.addInterceptor(new GreetingInterceptor()).order(0);
            registry.addInterceptor(new AnotherInterceptor())
            .addPathPatterns("/soojung")
            .order(-1);
    }
}
~~~
- 특정 패턴에 해당하는 요청에만 적용할 수도 있다.
- 순서를 지정 할 수 있다.

## 리소스핸들러
- [WebMvcConfigurer addResourceHandlers](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/config/annotation/WebMvcConfigurer.html#addResourceHandlers-org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry-)
- 이미지, 자바스크립트, CSS 그리고 HTML