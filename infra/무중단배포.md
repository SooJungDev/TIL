## 무중단배포란?
서비스를 정지 시키지 않고 배포를 계속하는것을 무중단 배포라고 함

무중단 배포 방식에는 몇가지가 있음
- AWS에서 Blue-Green 무중단 배포 구현
- 도커를 이용한 웹서비스 무중단 배포하기
- Nginx를 활용한 무중단 배포 
- L4 스위치를 이용한 무중단 배포(L4 고가의 장비 잘쓰지 않는다..)


## Nginx는? 
- 트래픽이 많은 웹사이트 확정성을 외해 설계한 비동기 이벤트 기반 구조의 웹서버
- 비동기 Event-Driven 기반 구조
- 다수의 연결을 효과적으로 처리가능
- 대부분의 코어 모듈이 Apache 보다 적은 리소스로 더 빠르게 동작가능
- 더작은 쓰레드로 클라이언트 요청들을 처리가능



## Nginx를 이용한 무중단 배포 방법 
- Nginx를 이요한 무중단 배포를 하는 이유는 간단 제일저렴하기때문에

구조는
하나의 서버에 Nginx 1대와 스프링 부트 jar 2대를 사용하는것
Nginx는 80(http), 443(https) 포트를 할당하고,  
스프링 부트 1은 8081 포트로,   
스프링 부트2는 8082 포트로 실행함

<img width="628" alt="2019-02-22 2 30 22" src="https://user-images.githubusercontent.com/38197944/53221868-c511d380-36ae-11e9-855e-3724fe1e9f60.png">  


- 사용자는 서비스 주소로 접속 (80 혹은 443 포트)
- Nginx는 사용자의 요청을 받아 현재 연결된 스프링부트로 요청을 전달
    - 스프링 부트1: 8081 포트로 요청을 전달한다고 가정
- 스프링 부트2는 Ngix와 연결된 상태가 아니니 요청을 받지못함

<img width="668" alt="2019-02-22 2 38 17" src="https://user-images.githubusercontent.com/38197944/53222075-9811f080-36af-11e9-98ff-2a66b735b63f.png">  

- 신규 배포가 필요하면 Nginx와 연결되지 않는 스프링부트2로 배포
- 배포하는 동안에도 서비스는 중단되지 않는다.
    - Nginx는 스프링부트1을 바라보기 떄문에
- 배포가 끝나고 정상적으로 스프링부트 2가 구동중인지 확인
- 스프링부트2가 정상 구동중이면 nginx reload를 통해 8081대신에 8082를 바라보도록함
- Nginx Reload는 1초 이내에 실행완료

<img width="723" alt="2019-02-22 2 48 29" src="https://user-images.githubusercontent.com/38197944/53222414-fb505280-36b0-11e9-9edf-4c2441404b50.png">

- 또다시 배포가 필요하면 스프링부트 1로 배포함
    - 현재는 스프링부트2가 Nginx가 연결되었기 때문
- 스프링부트1 배포가 끝났다면 Nginx가 스프링부트1을 바라보도록하고 nginx reload 실행함
- 스프링부트1로 Nginx가 요청을 전달함

문제가 생기면?!!!
- Nginx가 8082포트(스프링부트2)를 보도록 변경하면됨

리버스 프록시
- 외부에서 내부서버가 제공하는 서비스 접근시 , Proxy 서버를 먼저 거쳐서 내부서버로 들어오는방식
    - 장점: 보안, 로드밸런싱
- Nginx가 외부의 요청을 받아 뒷단 서버로 요청을 전달하는 행위를 리버스 프록시
- 이런 리버스 프록시 서버는 요청을 전달하고 , 실제 요청에 대한 처리는 뒷단의 웹서버들이 처리함




## 참고사이트
- [AWS 에서 Blue-Green 무중단 배포 구현](https://sangwook.github.io/2014/01/28/zero-downtime-blue-green-deployments-aws.html)
- [도커를 이용한 웹서비스 무중단 배포하기](https://subicura.com/2016/06/07/zero-downtime-docker-deployment.html)
- [스프링부트로 웹 서비스 출시하기 - 7. Nginx를 활용한 무중단 배포 구축하기](https://jojoldu.tistory.com/267)
- [nginx의 이해와 활용](https://m.blog.naver.com/jhc9639/220967352282)
